---
title: Hadoop学习记录
date: 2017-07-20 13:27
---

# Hadoop学习记录

## zookeeper
### 概述:
* 相比单机环境，由于分布式环境的单机差异，网络传输的不可靠性，以及多服务的一致性等问题，因此同步/协调的实现更加复杂；
* zookeeper为一种采用zab协议的分布式协调技术（解决分布式环境在多个线程间的同步问题，控制临界资源的访问），实现一种分布式锁，协调进程对资源的访问/操作；
* 除分布式锁服务之外，还有配置服务，组服务，分布式消息队列，分布式通知/协调等；
* zookeeper能够用在大型的分布式系统之中， 不会因为一个节点的错误而崩溃，同时严格的序列访问控制，复杂的控制原语，保证其具有良好的可靠性，一致性，容错性
* zookeeper实现了一种新的数据结构Znode,并在该数据结构的基础上定义了一些原语，同时实现了一种通信机制-Watcher机制，从实现其提供的分布式协调服务
### 数据模型Znode：
* zookeeper拥有一个树状层次结构的命名空间，树中的每个节点称为一个Znode（同目录结构类似）,同时利用唯一的“绝对路径”标识节点，特别的“/zookeeper”用以保存配额等管理信息
* 每个Znode由三个部分组成:
    * state:状态信息，如Znode的版本，权限等信息(每个节点拥有自己的访问控制表ACL，限定了特定用户可以对该节点的操作)
    * data: 与此Znode关联的数据，通常是一些配置文件信息，状态信息，汇集信息等一些小数据，大小限制为1M,且数据上的操作为原子性
    * children: 子节点
* zookeeper中的Znode可分为临时节点和永久节点两种(均在创建是被确定，且不能更改):
    * 临时节点与客户端会话绑定，生命周期依赖于创建它们的会话（但对所有客户端可见），会话结束，节点删除。临时节点不允许拥有子节点。
    * 永久节点的生命周期不依赖于会话，只有客户端显式执行删除操作时，才会被删除
* 客户端可以在Znode上设置监视器watch,当节点状态发生改变时(增/删/改)，将会触发watch所对应的操作。watch被触发时，Zookeeper将向客户端发送一条通知。
#### Zookeeper中的时间：
* 致使Znode状态改变的所有操作都会使改节点接收到一个唯一的Zxid格式的时间戳，且这个时间戳全局有序。
* 每个Znode维护三个时间戳:cZxid(创建时间)，mZxid（修改时间），pZxid
* Zxid为64位的数字，高32为epoch标识leader关系是否改变(每个leader被选出来都会有一个新的epoch);低32位一个递增计数为版本号，对节点的每一个操作都会使该节点的版本号增加，每个节点维护着三个版本号：version(节点数据版本号)/cversion(子节点版本号)/aversion(节点拥有的ACL版本号)
### Watch触发器：
* ZooKeeper可以为所有的读操作设置watch，这些读操作包括：exists()、getChildren()及getData()。watch事件是一次性的触发器，当watch的对象状态发生改变时，将会触发此对象上watch所对应的事件。watch事件将被异步地发送给客户端，并且ZooKeeper为watch机制提供了有序的一致性保证。理论上，客户端接收watch事件的时间要快于其看到watch对象状态变化的时间。
* watch类型可以分为两类：
    * ① 数据watch(data  watches)：getData和exists负责设置数据watch
    * ② 孩子watch(child watches)：getChildren负责设置孩子watch
* Watch由客户端所连接的ZooKeeper服务器在本地维护,客户端重新建立连接的时候，任何先前 注册过的watch都会被重新注册。
* watch实际上要处理两类事件(都在Watch中处理,即重载的process(Event event)):
    * 1.连接状态事件(type=None, path=null):不需要注册，不需连续触发，只需处理
    * 2.节点事件:节点的建立，删除，数据的修改。是one time trigger，我们需要不停的注册触发，还可能发生事件丢失的情况



## Oozie
### 概述：
* Oozie是一个基于工作流引擎的服务器,专门针对大规模复杂工作流程和数据管道设计，可以把多个任务组成一个工作流，自动完成任务的调用(避免需要手动执行来保证任务间的依赖关系)，可以在上面运行Hadoop的Map Reduce和Pig任务。本质为一个运行在Java Servlet容器中的Javas Web应用；
* 围绕两个核心：工作流和协调器，前者定义任务的拓扑和执行逻辑，后者负责工作流的依赖和触发。
* 通过有向无环图的机制控制工作流,即一个操作的输入依赖于前一个任务的输出，前一个操作完全完成后，才能开始第二个；通过时间（频率）以及有效数据触发当前的Oozie工作流程协调作业
* 通过hPDL（一种XML的流程定义语言）定义工作流,工作流操作通过远程系统启动任务。当任务完成后，远程系统会进行回调来通知任务已经结束，然后再开始下一个操作。

### 工作流：
* Oozie工作流是一系列的操作图，包含控制流节点和操作节点：
    * 控制流节点:定义了工作流的开始和结束（start,end以及fail的节点），并控制工作流执行路径（decision,fork,join节点）;
    * 操作节点:工作流触发计算\处理任务的执行，Oozie支持不同的任务类型(hadoop mapreduce任务，hdfs,Pig，SSH,eMail,Oozie子工作流等)。此外Oozie可以自定义扩展任务类型。
* Oozie工作流可以参数化的方式执行（使用变量${inputDir}定义）。提交工作流任务的时需要同时提供参数。如果参数合适（使用不同的目录）就可以定义并行的工作流任务。

